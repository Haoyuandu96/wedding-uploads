<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Eric & Darya â€“ Wedding Uploads</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}</style>
</head>
<body class="bg-slate-50 min-h-screen">
  <main class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center">Share Your Photos & Videos ðŸŽ‰</h1>
    <p class="text-center text-slate-600 mt-1">Use the passcode on your program.</p>

    <section class="bg-white rounded-2xl p-6 mt-6 shadow">
      <form id="uploadForm" class="grid gap-3">
        <div class="grid md:grid-cols-2 gap-3">
          <input name="name" required placeholder="Your name" class="border rounded-xl px-4 py-3"/>
          <input name="passcode" required placeholder="Passcode" class="border rounded-xl px-4 py-3"/>
        </div>
        <input id="file" name="file" type="file" accept="image/*,video/*" required class="border rounded-xl px-4 py-3"/>
        <button id="submitBtn" class="bg-black text-white rounded-xl px-5 py-3 font-semibold hover:opacity-90 disabled:opacity-50 w-full md:w-auto">Upload</button>

        <div id="progressWrap" class="hidden">
          <div class="flex justify-between text-sm text-slate-600">
            <span>Uploadingâ€¦</span><span id="progressText">0%</span>
          </div>
          <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
            <div id="progressBar" class="bg-black h-2 w-0"></div>
          </div>
        </div>
        <p id="message" class="text-sm mt-2"></p>
      </form>
    </section>

    <section class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Latest uploads</h2>
        <button id="refreshBtn" class="text-sm underline">Refresh</button>
      </div>
      <div id="gallery" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3"></div>
    </section>
  </main>

<script>
const WORKER_BASE = "https://broken-tree-9fda.haoyuandu96.workers.dev";

const form = document.getElementById('uploadForm');
const msg  = document.getElementById('message');
const progressWrap = document.getElementById('progressWrap');
const progressBar  = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const submitBtn    = document.getElementById('submitBtn');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = "";
  const fd = new FormData(form);
  const file = document.getElementById('file').files[0];
  if (!file) return;

  if (file.size > 200 * 1024 * 1024) {
    msg.textContent = "File too large (max 200MB).";
    msg.className = "text-red-600 text-sm mt-2";
    return;
  }

  submitBtn.disabled = true;
  progressWrap.classList.remove('hidden');

  try {
    await new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', WORKER_BASE + '/api/upload');
      xhr.upload.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const pct = Math.round((ev.loaded / ev.total) * 100);
          progressBar.style.width = pct + '%';
          progressText.textContent = pct + '%';
        }
      };
      xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error(xhr.responseText || 'Upload failed'));
      xhr.onerror = () => reject(new Error('Network error'));
      xhr.send(fd);
    });
    msg.textContent = "Thanks! Upload complete.";
    msg.className = "text-green-700 text-sm mt-2";
    form.reset();
    progressBar.style.width = '0%'; progressText.textContent = '0%';
    loadGallery();
  } catch (err) {
    try {
      const e = JSON.parse(err.message); msg.textContent = e.error || "Upload failed";
    } catch { msg.textContent = err.message || "Upload failed"; }
    msg.className = "text-red-600 text-sm mt-2";
  } finally {
    submitBtn.disabled = false;
    progressWrap.classList.add('hidden');
  }
});

async function loadGallery(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  try{
    const res = await fetch(WORKER_BASE + '/api/list');
    const { items } = await res.json();
    (items || []).forEach(it => {
      const type = (it.contentType || '').split('/')[0];
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow overflow-hidden';
      if (type === 'video') {
        const v = document.createElement('video');
        v.src = it.url; v.controls = true; v.playsInline = true;
        v.className = 'w-full h-48 object-cover';
        card.appendChild(v);
      } else {
        const img = document.createElement('img');
        img.src = it.url; img.alt = it.name || 'Upload'; img.loading='lazy';
        img.className = 'w-full h-48 object-cover';
        card.appendChild(img);
      }
      const meta = document.createElement('div');
      meta.className = 'p-3 text-sm text-slate-600 flex justify-between';
      meta.innerHTML = `<span>${it.uploader || 'Guest'}</span><span>${new Date(it.uploadedAt).toLocaleString()}</span>`;
      card.appendChild(meta);
      gallery.appendChild(card);
    });
  }catch(e){ console.error(e); }
}
document.getElementById('refreshBtn').addEventListener('click', loadGallery);
loadGallery();
</script>
</body>
</html>
