<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Eric & Darya ‚Äî 08¬∑23¬∑2025</title>
  <meta name="description" content="Share your photos & videos from Eric & Darya's wedding."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --paper: #FAF7F2; --ink: #111111; --accent: #C9A227;
    }
    html, body { background: var(--paper); color: var(--ink); }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.07); }
    .gold-grad { background: radial-gradient(1200px 300px at 50% -50px, rgba(201,162,39,.25), rgba(201,162,39,0) 60%); }
    .badge { background: rgba(201,162,39,.12); color: var(--ink); border: 1px solid rgba(201,162,39,.35); }
    .btn-primary { background: var(--ink); color: white; }
    .btn-primary:hover { opacity: .95; }
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.85); display: none; align-items: center; justify-content: center; z-index: 50; }
    .lightbox.open { display: flex; }
    .lightbox-inner { max-width: 95vw; max-height: 90vh; }
    .lightbox img, .lightbox video { max-width: 95vw; max-height: 90vh; object-fit: contain; border-radius: 12px; }
    .close-btn { position: fixed; top: 12px; right: 12px; background: rgba(255,255,255,.15); color: #fff; border-radius: 9999px; padding: 10px 14px; font-weight: 700; }
    .trash-btn { position:absolute; top:8px; right:8px; background: rgba(0,0,0,.55); color:#fff; border-radius:8px; padding:4px 6px; font-size:12px; display:none; }
    .admin-on .trash-btn { display:block; }
  </style>
</head>
<body class="min-h-screen gold-grad">
  <main class="max-w-5xl mx-auto px-4 py-8 md:py-10">
    <!-- HERO -->
    <header class="text-center mb-8">
      <div class="mx-auto w-28 h-28 rounded-full border-2" style="border-color: var(--accent); display:grid; place-items:center;">
        <svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" x2="1">
            <stop offset="0%" stop-color="#C9A227" stop-opacity=".95"/>
            <stop offset="100%" stop-color="#C9A227" stop-opacity=".65"/>
          </linearGradient></defs>
          <text x="16" y="42" font-family="Playfair Display, serif" font-weight="700" font-size="28" fill="url(#g)">E</text>
          <text x="44" y="42" font-family="Playfair Display, serif" font-weight="700" font-size="28" fill="url(#g)">D</text>
          <path d="M36 26c2.6-4.3 9-4.2 11.4-.1 2 3.2.7 7.6-2.2 10.2L36 45 26.8 36.1c-3-2.6-4.2-7.1-2.3-10.3 2.3-4.1 8.7-4.2 11.5.2z" fill="#C9A227" fill-opacity=".35"/>
        </svg>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mt-4" style="font-family: 'Playfair Display', serif;">Eric & Darya</h1>
      <p class="text-slate-600 mt-1">August 23, 2025</p>
      <div class="inline-block px-3 py-1 rounded-full text-xs mt-2 badge">Share your favorite moments with us üíõ</div>
    </header>

    <!-- ADMIN BAR -->
    <div class="flex items-center justify-end gap-2 mb-3">
      <button id="adminToggle" class="text-xs underline">Admin mode</button>
      <span id="adminStatus" class="text-xs text-slate-500"></span>
    </div>

    <!-- HOW TO -->
    <section class="bg-white rounded-2xl p-6 md:p-7 card mb-8">
      <h2 class="text-lg font-semibold mb-2">How to upload</h2>
      <ol class="list-decimal pl-5 space-y-1 text-slate-700 text-sm">
        <li>Tap <b>Select files</b> and choose photos/videos (you can select multiple).</li>
        <li>Enter your <b>name</b>, then press <b>Upload selected</b>.</li>
        <li>Keep this tab open until it says ‚ÄúUpload complete‚Äù.</li>
        <li>Your items appear below in the live gallery. Thank you! ü•Ç</li>
      </ol>
    </section>

    <!-- UPLOAD -->
    <section class="bg-white rounded-2xl p-6 md:p-7 card">
      <h2 class="text-xl font-semibold">Upload photos & videos</h2>
      <p class="text-slate-600 mt-1 text-sm">Max 200 MB each ‚Ä¢ JPG/PNG/HEIC/WEBP/MP4/MOV.</p>

      <form id="uploadForm" class="mt-4 grid gap-3">
        <div class="grid md:grid-cols-3 gap-3">
          <input name="name" id="guestName" required placeholder="Your name" class="border rounded-xl px-4 py-3 focus:outline-none focus:ring w-full"/ autocomplete="name">
          <div class="grid gap-2 md:col-span-2">
            <label class="text-xs text-slate-600">Select files</label>
            <input id="file" name="file" type="file" multiple accept="image/*,video/*" required class="border rounded-xl px-4 py-3 focus:outline-none focus:ring w-full"/>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:items-center mt-1">
          <button id="submitBtn" class="btn-primary rounded-xl px-5 py-3 font-semibold w-full sm:w-auto disabled:opacity-50" type="submit">Upload selected</button>
          <span class="text-xs text-slate-500">You can select multiple files; they‚Äôll upload one by one.</span>
        </div>

        <div class="hidden" id="progressWrap">
          <div class="flex justify-between text-sm text-slate-600"><span id="progressLabel">Uploading‚Ä¶</span><span id="progressText">0%</span></div>
          <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
            <div id="progressBar" class="h-2 w-0" style="background: var(--accent);"></div>
          </div>
        </div>

        <p id="message" class="text-sm mt-2"></p>
      </form>
    </section>

    <!-- GALLERY -->
    <section class="mt-10">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Live gallery</h2>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="text-sm underline">Refresh</button>
        </div>
      </div>
      <div id="gallery" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3"></div>
    </section>

    <footer class="text-center text-slate-500 text-xs mt-10">
      <p>Please keep content family‚Äëfriendly. Do not upload others without consent.</p>
      <p class="mt-1">¬© 2025 Eric & Darya</p>
    </footer>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <button id="closeLightbox" class="close-btn" aria-label="Close">‚úï</button>
    <div class="lightbox-inner">
      <img id="lightboxImg" alt="Zoomed image" style="display:none"/>
      <video id="lightboxVideo" controls playsinline style="display:none"></video>
    </div>
  </div>

<script>
const WORKER_BASE = "https://broken-tree-9fda.haoyuandu96.workers.dev";

const form = document.getElementById('uploadForm');
const msg  = document.getElementById('message');
const progressWrap = document.getElementById('progressWrap');
const progressBar  = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const progressLabel= document.getElementById('progressLabel');
const submitBtn    = document.getElementById('submitBtn');
const fileInput    = document.getElementById('file');

let adminPin = "";
let adminOn = false;

document.getElementById('adminToggle').addEventListener('click', async () => {
  if (!adminOn) {
    const pin = prompt("Enter admin PIN");
    if (!pin) return;
    // simple trial delete call with empty key to validate (backend will just 400/401)
    const res = await fetch(WORKER_BASE + "/api/list"); // minimal check: rely on 401 on delete later
    adminPin = pin;
    adminOn = true;
    document.body.classList.add('admin-on');
    document.getElementById('adminStatus').textContent = "Admin mode ON";
  } else {
    adminOn = false;
    adminPin = "";
    document.body.classList.remove('admin-on');
    document.getElementById('adminStatus').textContent = "";
  }
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = "";
  const files = Array.from(fileInput.files || []);
  if (!files.length) return;

  submitBtn.disabled = true;
  progressWrap.classList.remove('hidden');

  try {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      if (file.size > 200 * 1024 * 1024) {
        msg.textContent = "One of your files is too large (max 200MB).";
        msg.className = "text-red-600 text-sm mt-2";
        continue;
      }
      const fd = new FormData(form);
      fd.set('file', file);
      progressLabel.textContent = "Uploading " + (i+1) + " of " + files.length + "‚Ä¶";

      await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', WORKER_BASE + '/api/upload');
        xhr.upload.onprogress = (ev) => {
          if (ev.lengthComputable) {
            const pct = Math.round((ev.loaded / ev.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = pct + '%';
          }
        };
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error(xhr.responseText || 'Upload failed'));
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(fd);
      });
    }
    msg.textContent = "Thank you! Upload(s) complete.";
    msg.className = "text-green-700 text-sm mt-2";
    form.reset();
    progressBar.style.width = '0%'; progressText.textContent = '0%';
    await loadGallery();
  } catch (err) {
    try { const e = JSON.parse(err.message); msg.textContent = e.error || "Upload failed"; }
    catch { msg.textContent = err.message || "Upload failed"; }
    msg.className = "text-red-600 text-sm mt-2";
  } finally {
    submitBtn.disabled = false;
    progressWrap.classList.add('hidden');
  }
});

async function loadGallery(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  try{
    const res = await fetch(WORKER_BASE + '/api/list');
    const { items } = await res.json();
    (items || []).forEach(it => {
      const type = (it.contentType || '').split('/')[0];
      const card = document.createElement('div');
      card.className = 'relative bg-white rounded-xl card overflow-hidden' + (adminOn ? ' admin-on' : '');
      let el;
      if (type === 'video') {
        el = document.createElement('video');
        el.src = it.url; el.controls = true; el.playsInline = true;
        el.className = 'w-full h-48 object-cover';
        el.addEventListener('click', () => openLightbox('video', it.url));
        card.appendChild(el);
      } else {
        el = document.createElement('img');
        el.src = it.url; el.alt = it.name || 'Upload'; el.loading='lazy';
        el.className = 'w-full h-48 object-cover cursor-zoom-in';
        el.addEventListener('click', () => openLightbox('image', it.url));
        card.appendChild(el);
      }
      const meta = document.createElement('div');
      meta.className = 'p-3 text-sm text-slate-600 flex items-center justify-between';
      const date = new Date(it.uploadedAt);
      meta.innerHTML = "<span>" + (it.uploader || 'Guest') + "</span><span>" + (isNaN(date) ? '' : date.toLocaleString()) + "</span>";
      card.appendChild(meta);

      // delete button (shown in admin mode)
      const del = document.createElement('button');
      del.textContent = "Delete";
      del.className = 'trash-btn';
      del.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        if (!adminOn) return;
        if (!adminPin) { alert("Admin PIN required"); return; }
        if (!confirm("Delete this item?")) return;
        const r = await fetch(WORKER_BASE + '/api/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: it.key, pin: adminPin })
        });
        if (r.ok) { card.remove(); }
        else {
          const t = await r.text();
          alert('Delete failed: ' + t);
        }
      });
      card.appendChild(del);

      gallery.appendChild(card);
    });
  }catch(e){ console.error(e); }
}
document.getElementById('refreshBtn').addEventListener('click', loadGallery);
loadGallery();

// Lightbox logic
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lightboxImg');
const lbVid = document.getElementById('lightboxVideo');
const lbClose = document.getElementById('closeLightbox');

function openLightbox(kind, src) {
  if (kind === 'image') {
    lbVid.pause(); lbVid.style.display = 'none';
    lbImg.src = src; lbImg.style.display = 'block';
  } else {
    lbImg.style.display = 'none';
    lbVid.src = src; lbVid.style.display = 'block';
  }
  lb.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() { lb.classList.remove('open'); document.body.style.overflow = ''; lbVid.pause(); }
lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });
lbClose.addEventListener('click', closeLightbox);
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
</script>
<script>
(function(){
  const KEY = 'weddingUploads.guestName';
  const form = document.getElementById('uploadForm');
  const nameInput = document.getElementById('guestName') || document.querySelector('input[name="name"]');

  if (!form || !nameInput) return;

  function getSaved(){ try { return (localStorage.getItem(KEY) || '').trim(); } catch(e){ return ''; } }
  function save(n){ try { if (n) localStorage.setItem(KEY, n); } catch(e){} }
  function applySaved(){
    const s = getSaved();
    if (s && (!nameInput.value || nameInput.value.trim() === '')) {
      nameInput.value = s;
    }
  }

  // On load: prefill
  applySaved();

  // When user types/changes, persist
  function commit(){
    const n = (nameInput.value || '').trim();
    if (n) save(n);
  }
  nameInput.addEventListener('change', commit);
  nameInput.addEventListener('blur', commit);
  nameInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') commit(); });

  // Before submit: if empty but saved exists, fill it
  form.addEventListener('submit', () => {
    if (!nameInput.value.trim()) {
      const s = getSaved(); if (s) nameInput.value = s;
    } else {
      commit();
    }
  });

  // After form.reset(): re-apply saved name (reset fires an event)
  form.addEventListener('reset', () => {
    setTimeout(applySaved, 0);
  });

  // Expose helper consistent with previous instructions (non-breaking)
  window.getUploaderName = function(){
    const typed = (nameInput.value || '').trim();
    const s = getSaved();
    const n = typed || s;
    if (n) save(n);
    return n;
  };
})();
</script>
</body>
</html>
