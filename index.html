<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#FAF7F2"/>
  <title>Eric & Darya ‚Äî 08¬∑23¬∑2025</title>
  <meta name="description" content="Share your photos & videos from Eric & Darya's wedding."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --paper:#FAF7F2; --ink:#111111; --accent:#C9A227; }
    html, body { background: var(--paper); color: var(--ink); }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.07); }
    .gold-grad { background: radial-gradient(1200px 300px at 50% -50px, rgba(201,162,39,.25), rgba(201,162,39,0) 60%); }
    .badge { background: rgba(201,162,39,.12); border:1px solid rgba(201,162,39,.35); }
    .btn { border-radius: 14px; padding: 14px 16px; font-weight: 700; }
    .btn-primary { background: var(--ink); color:#fff; }
    .btn-secondary { background: #fff; border:1px solid rgba(0,0,0,.15); }
    .tap-lg * { min-height: 48px; }
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.9); display: none; align-items: center; justify-content: center; z-index: 50; }
    .lightbox.open { display: flex; }
    .lightbox-inner { max-width: 100vw; max-height: 92vh; padding: 10px; }
    .lightbox img, .lightbox video { max-width: 100vw; max-height: 92vh; object-fit: contain; border-radius: 12px; }
    .close-btn { position: fixed; top: 12px; right: 12px; background: rgba(0,0,0,.5); color: #fff; border-radius: 9999px; padding: 10px 14px; font-weight: 700; }
    .trash-btn { position:absolute; top:8px; right:8px; background: rgba(0,0,0,.55); color:#fff; border-radius:8px; padding:6px 10px; font-size:13px; display:none; }
    .admin-on .trash-btn { display:block; }
    .fab { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 40; }
    .fab-btn { background: var(--accent); color:#111; border-radius: 9999px; box-shadow: 0 10px 25px rgba(0,0,0,.2); padding: 16px 20px; font-weight: 800; }
  </style>
</head>
<body class="min-h-screen gold-grad">
  <main class="max-w-[680px] mx-auto px-4 py-5 md:py-10">
    <!-- HERO -->
    <header class="text-center mb-6 md:mb-8">
      <div class="mx-auto w-24 h-24 rounded-full border-2" style="border-color: var(--accent); display:grid; place-items:center;">
        <svg width="64" height="64" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#C9A227" stop-opacity=".95"/><stop offset="100%" stop-color="#C9A227" stop-opacity=".65"/></linearGradient></defs>
          <text x="18" y="44" font-family="Playfair Display, serif" font-weight="700" font-size="30" fill="url(#g)">E</text>
          <text x="42" y="44" font-family="Playfair Display, serif" font-weight="700" font-size="30" fill="url(#g)">D</text>
        </svg>
      </div>
      <h1 class="text-3xl md:text-5xl font-bold mt-3" style="font-family:'Playfair Display',serif;">Eric & Darya</h1>
      <p class="text-slate-600 mt-1">August 23, 2025</p>
      <div class="inline-block px-3 py-1 rounded-full text-xs mt-2 badge">Share your favorite moments with us üíõ</div>
    </header>

    <!-- Admin toggle -->
    <div class="flex items-center justify-end gap-2 mb-3">
      <button id="adminToggle" class="text-xs underline">Admin mode</button>
      <span id="adminStatus" class="text-xs text-slate-500"></span>
    </div>

    <!-- HOW TO -->
    <section class="bg-white rounded-2xl p-5 md:p-7 card mb-6 tap-lg">
      <h2 class="text-lg font-semibold mb-2">How to upload</h2>
      <ol class="list-decimal pl-5 space-y-1 text-slate-700 text-sm">
        <li>Tap <b>Choose from library</b> or <b>Take photo/video</b>.</li>
        <li>Enter your <b>name</b>, then hit <b>Upload</b>.</li>
        <li>Keep this tab open until it says ‚ÄúDone‚Äù.</li>
        <li>Your items will show below. Thank you! ü•Ç</li>
      </ol>
    </section>

    <!-- UPLOAD -->
    <section class="bg-white rounded-2xl p-5 md:p-7 card tap-lg">
      <h2 class="text-xl font-semibold">Upload</h2>
      <p class="text-slate-600 mt-1 text-sm">Max 200 MB each ‚Ä¢ JPG/PNG/HEIC/WEBP/MP4/MOV.</p>

      <form id="uploadForm" class="mt-4 grid gap-3">
        <input name="name" required placeholder="Your name" class="border rounded-xl px-4 py-3 w-full text-lg"/>

        <!-- hidden inputs for camera capture -->
        <input id="cameraPhoto" type="file" accept="image/*" capture="environment" class="hidden">
        <input id="cameraVideo" type="file" accept="video/*" capture class="hidden">

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button id="btnChoose" type="button" class="btn btn-secondary">Choose from library</button>
          <button id="btnCamera" type="button" class="btn btn-secondary">Take photo / video</button>
        </div>

        <input id="file" name="file" type="file" multiple accept="image/*,video/*" class="hidden"/>
        <div id="selectedHint" class="text-xs text-slate-600"></div>

        <button id="submitBtn" class="btn btn-primary w-full">Upload selected</button>

        <div class="hidden" id="progressWrap">
          <div class="flex justify-between text-sm text-slate-600"><span id="progressLabel">Uploading‚Ä¶</span><span id="progressText">0%</span></div>
          <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="h-3 w-0" style="background: var(--accent);"></div>
          </div>
        </div>

        <p id="message" class="text-sm mt-2"></p>
      </form>
    </section>

    <!-- GALLERY -->
    <section class="mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Live gallery</h2>
        <button id="refreshBtn" class="text-sm underline">Refresh</button>
      </div>
      <div id="gallery" class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2"></div>
    </section>
  </main>

  <!-- Floating upload button -->
  <div class="fab">
    <button id="fabUpload" class="fab-btn">Ôºã Upload</button>
  </div>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <button id="closeLightbox" class="close-btn" aria-label="Close">‚úï</button>
    <div class="lightbox-inner">
      <img id="lightboxImg" alt="Zoomed image" style="display:none"/>
      <video id="lightboxVideo" controls playsinline style="display:none"></video>
    </div>
  </div>

<script>
const WORKER_BASE = "https://broken-tree-9fda.haoyuandu96.workers.dev";
const form = document.getElementById('uploadForm');
const msg  = document.getElementById('message');
const progressWrap = document.getElementById('progressWrap');
const progressBar  = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const progressLabel= document.getElementById('progressLabel');
const submitBtn    = document.getElementById('submitBtn');
const fileInput    = document.getElementById('file');
const cameraPhoto  = document.getElementById('cameraPhoto');
const cameraVideo  = document.getElementById('cameraVideo');
const selectedHint = document.getElementById('selectedHint');

let adminPin = ""; let adminOn = false;

document.getElementById('adminToggle').addEventListener('click', async () => {
  if (!adminOn) {
    const pin = prompt("Enter admin PIN");
    if (!pin) return;
    adminPin = pin; adminOn = true;
    document.body.classList.add('admin-on');
    document.getElementById('adminStatus').textContent = "Admin mode ON";
    await loadGallery();
  } else {
    adminOn = false; adminPin = "";
    document.body.classList.remove('admin-on');
    document.getElementById('adminStatus').textContent = "";
    await loadGallery();
  }
});

// Buttons to choose/capture
document.getElementById('btnChoose').addEventListener('click', () => fileInput.click());
document.getElementById('btnCamera').addEventListener('click', () => {
  // Offer a quick chooser: if confirm ‚Üí photo, else video
  if (confirm("Take a photo? Click Cancel for video.")) cameraPhoto.click();
  else cameraVideo.click();
});
document.getElementById('fabUpload').addEventListener('click', () => fileInput.click());

// When user selects files, update hint & stage into main file input
[cameraPhoto, cameraVideo, fileInput].forEach(inp => {
  inp.addEventListener('change', (e) => {
    if (inp !== fileInput && inp.files && inp.files.length) {
      // Merge camera-captured file into main input using DataTransfer
      const dt = new DataTransfer();
      for (const f of fileInput.files) dt.items.add(f);
      for (const f of inp.files) dt.items.add(f);
      fileInput.files = dt.files;
      inp.value = "";
    }
    const count = fileInput.files?.length || 0;
    selectedHint.textContent = count ? (count + " file" + (count>1?"s":"") + " ready") : "";
  });
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = "";
  const files = Array.from(fileInput.files || []);
  if (!files.length) return alert("Please select at least one file.");

  submitBtn.disabled = true;
  progressWrap.classList.remove('hidden');

  try {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      if (file.size > 200 * 1024 * 1024) {
        msg.textContent = "One of your files is too large (max 200MB).";
        msg.className = "text-red-600 text-sm mt-2";
        continue;
      }
      const fd = new FormData(form);
      fd.set('file', file);
      progressLabel.textContent = "Uploading " + (i+1) + " of " + files.length + "‚Ä¶";

      await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', WORKER_BASE + '/api/upload');
        xhr.upload.onprogress = (ev) => {
          if (ev.lengthComputable) {
            const pct = Math.round((ev.loaded / ev.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = pct + '%';
          }
        };
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error(xhr.responseText || 'Upload failed'));
        xhr.onerror = () => reject(new Error('Network error'));
        xhr.send(fd);
      });
    }
    msg.textContent = "Done! Upload(s) complete.";
    msg.className = "text-green-700 text-sm mt-2";
    form.reset(); fileInput.value = ""; selectedHint.textContent = "";
    progressBar.style.width = '0%'; progressText.textContent = '0%';
    await loadGallery();
  } catch (err) {
    try { const e = JSON.parse(err.message); msg.textContent = e.error || "Upload failed"; }
    catch { msg.textContent = err.message || "Upload failed"; }
    msg.className = "text-red-600 text-sm mt-2";
  } finally {
    submitBtn.disabled = false;
    progressWrap.classList.add('hidden');
  }
});

async function loadGallery(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  try{
    const res = await fetch(WORKER_BASE + '/api/list');
    const { items } = await res.json();
    (items || []).forEach(it => {
      const type = (it.contentType || '').split('/')[0];
      const card = document.createElement('div');
      card.className = 'relative bg-white rounded-xl card overflow-hidden';
      let el;
      if (type === 'video') {
        el = document.createElement('video');
        el.src = it.url; el.controls = true; el.playsInline = true;
        el.className = 'w-full h-44 object-cover';
        el.addEventListener('click', () => openLightbox('video', it.url));
        card.appendChild(el);
      } else {
        el = document.createElement('img');
        el.src = it.url; el.alt = it.name || 'Upload'; el.loading='lazy';
        el.className = 'w-full h-44 object-cover cursor-zoom-in';
        el.addEventListener('click', () => openLightbox('image', it.url));
        card.appendChild(el);
      }
      const meta = document.createElement('div');
      meta.className = 'p-3 text-sm text-slate-600 flex items-center justify-between';
      const date = new Date(it.uploadedAt);
      meta.innerHTML = "<span>" + (it.uploader || 'Guest') + "</span><span>" + (isNaN(date) ? '' : date.toLocaleString()) + "</span>";
      card.appendChild(meta);

      if (adminOn) {
        const del = document.createElement('button');
        del.textContent = "Delete";
        del.className = 'trash-btn';
        del.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          if (!confirm("Delete this item?")) return;
          const r = await fetch(WORKER_BASE + '/api/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: it.key, pin: adminPin })
          });
          if (r.ok) card.remove();
          else alert('Delete failed: ' + await r.text());
        });
        card.appendChild(del);
      }

      gallery.appendChild(card);
    });
  }catch(e){ console.error(e); }
}
document.getElementById('refreshBtn').addEventListener('click', loadGallery);
loadGallery();

// Lightbox
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lightboxImg');
const lbVid = document.getElementById('lightboxVideo');
const lbClose = document.getElementById('closeLightbox');
function openLightbox(kind, src) {
  if (kind === 'image') { lbVid.pause(); lbVid.style.display='none'; lbImg.src=src; lbImg.style.display='block'; }
  else { lbImg.style.display='none'; lbVid.src=src; lbVid.style.display='block'; }
  lb.classList.add('open'); document.body.style.overflow='hidden';
}
function closeLightbox() { lb.classList.remove('open'); document.body.style.overflow=''; lbVid.pause(); }
lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });
lbClose.addEventListener('click', closeLightbox);
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
</script>
</body>
</html>
